{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %}

{% block stylesheets %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.css" rel="stylesheet">
<style>
    .chart-container {
        margin-bottom: 30px;
    }
    .legend-container {
        margin-top: 10px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .legend-item span {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 5px;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="page-breadcrumb">
    <div class="row align-items-center">
        <div class="col-md-6 col-8 align-self-center">
            <h3 class="page-title mb-0 p-0">Dashboard</h3>
            <div class="d-flex align-items-center">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                    </ol>
                </nav>
            </div>
        </div>
        <div class="col-md-6 col-4 align-self-center">
            <div class="text-end upgrade-btn">
                <a href="https://appseed.us/support/" class="btn btn-danger d-none d-md-inline-block text-white" target="_blank">
                    Support
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <h1>IPTables Log Data Visualization</h1>
    <div id="charts-container"></div>
</div>
{% endblock content %}

{% block javascripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
<script>
    // Data passed from the Flask backend
    const aggregatedData = JSON.parse('{{ aggregated_data | tojson | safe }}');

    // Function to render pie charts
    function renderPieChart(containerId, title, data) {
        const chartContainer = document.createElement('div');
        chartContainer.id = containerId;
        chartContainer.className = 'chart-container';
        document.getElementById('charts-container').appendChild(chartContainer);

        const chart = c3.generate({
            bindto: `#${containerId}`,
            data: {
                columns: data,
                type: 'pie',
            },
            pie: {
                title: title,
            },
            tooltip: {
                format: {
                    value: function (value, ratio, id) {
                        return d3.format('.1%')(ratio);
                    }
                }
            }
        });

        // Create legend
        const legendContainer = document.createElement('div');
        legendContainer.className = 'legend-container';
        chartContainer.appendChild(legendContainer);

        data.forEach(item => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.innerHTML = `<span style="background-color:${chart.color(item[0])};"></span> ${item[0]}`;
            legendContainer.appendChild(legendItem);
        });
    }

    // Dynamically create pie charts for each field
    Object.keys(aggregatedData).forEach(field => {
        renderPieChart(`${field}-chart`, `Distribution of ${field}`, aggregatedData[field]);
    });
</script>
{% endblock javascripts %}
