{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

    <!-- chartist CSS -->
    <link href="{{ config.ASSETS_ROOT }}/plugins/chartist-js/dist/chartist.min.css" rel="stylesheet">
    <link href="{{ config.ASSETS_ROOT }}/plugins/chartist-js/dist/chartist-init.css" rel="stylesheet">
    <link href="{{ config.ASSETS_ROOT }}/plugins/chartist-plugin-tooltip-master/dist/chartist-plugin-tooltip.css" rel="stylesheet">
    <!--This page css - Morris CSS -->
    <link href="{{ config.ASSETS_ROOT }}/plugins/c3-master/c3.min.css" rel="stylesheet">

{% endblock stylesheets %}

{% block content %}
    <style>
        .form-container {
            margin: 20px;
        }
        .form-row {
            margin-bottom: 10px;
        }
        .is-invalid {
            border-color: #dc3545;
        }
        .error-message {
            display: none;
            position: absolute;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 5px;
            border-radius: 5px;
            z-index: 1000;
        }
        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .manual-rule-container {
            display: none;
            margin-top: 20px;
        }
    </style>

    <!-- ============================================================== -->
    <!-- Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <div class="page-breadcrumb">
        <div class="row align-items-center">
            <div class="col-md-6 col-8 align-self-center">
                <h3 class="page-title mb-0 p-0">Dashboard</h3>
                <div class="d-flex align-items-center">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                        </ol>
                    </nav>
                </div>
            </div>
            <div class="col-md-6 col-4 align-self-center">
                <div class="text-end upgrade-btn">
                        <a href="https://appseed.us/support/"
                        class="btn btn-danger d-none d-md-inline-block text-white" target="_blank">
                        Support        
                        </a>
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- End Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Container fluid  -->
    <!-- ============================================================== -->
    <div class="container form-container">
        <h2>Add New Rule</h2>
        <div class="rule-header">
            <span>Rule number 1</span>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeRule(this)">Delete</button>
        </div>
        <form id="rulesForm" method="POST" action="{{ url_for('home_blueprint.add_rule') }}">
            <input type="hidden" id="errorMessage" value="{{ error_message }}">
            <div id="rulesContainer">
                <div class="form-row">
                    <div class="col">
                        <select class="form-control" name="chain[]" required>
                            <option value="INPUT">INPUT</option>
                            <option value="OUTPUT">OUTPUT</option>
                            <option value="FORWARD">FORWARD</option>
                        </select>
                    </div>
                    <div class="col">
                        <select class="form-control" name="target[]" required>
                            <option value="drop">DROP</option>
                            <option value="accept">ACCEPT</option>
                            <option value="reject">REJECT</option>
                            <option value="log">LOG</option>
                            <option value="return">RETURN</option>
                        </select>
                        <div class="error-message">Please enter a valid action (drop, accept, reject, log, return).</div>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" name="prot[]" placeholder="Protocol" required>
                        <div class="error-message">Please enter a valid protocol.</div>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" name="source[]" placeholder="Source" required>
                        <div class="error-message">Please enter a valid IP address (e.g., 192.168.0.1).</div>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" name="destination[]" placeholder="Destination" required>
                        <div class="error-message">Please enter a valid IP address (e.g., 192.168.0.1).</div>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" name="sport[]" placeholder="Source Port">
                        <div class="error-message">Please enter a valid port number (1-65535).</div>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" name="dport[]" placeholder="Destination Port">
                        <div class="error-message">Please enter a valid port number (1-65535).</div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary" id="addRuleButton">Add New Rule</button>
            <button type="button" class="btn btn-info" id="manualRuleButton">Manual Rule</button>
            <div class="manual-rule-container" id="manualRuleContainer">
                <textarea class="form-control" name="manual_rule" placeholder="Enter iptables command"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>

    <script>
        let ruleNumber = 2;

        document.getElementById('addRuleButton').addEventListener('click', function() {
            var rulesContainer = document.getElementById('rulesContainer');
            var newRow = document.createElement('div');
            newRow.className = 'form-row';
            newRow.innerHTML = `
                <div class="rule-header">
                    <span>Rule number ${ruleNumber}</span>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRule(this)">Delete</button>
                </div>
                <div class="col">
                    <select class="form-control" name="chain[]">
                        <option value="INPUT">INPUT</option>
                        <option value="OUTPUT">OUTPUT</option>
                        <option value="FORWARD">FORWARD</option>
                    </select>
                </div>
                <div class="col">
                    <select class="form-control" name="target[]" required>
                        <option value="drop">DROP</option>
                        <option value="accept">ACCEPT</option>
                        <option value="reject">REJECT</option>
                        <option value="log">LOG</option>
                        <option value="return">RETURN</option>
                    </select>
                    <div class="error-message">Please enter a valid action (drop, accept, reject, log, return).</div>
                </div>
                <div class="col">
                    <input type="text" class="form-control" name="prot[]" placeholder="Protocol" required>
                    <div class="error-message">Please enter a valid protocol.</div>
                </div>
                <div class="col">
                    <input type="text" class="form-control" name="source[]" placeholder="Source" required>
                    <div class="error-message">Please enter a valid IP address (e.g., 192.168.0.1).</div>
                </div>
                <div class="col">
                    <input type="text" class="form-control" name="destination[]" placeholder="Destination" required>
                    <div class="error-message">Please enter a valid IP address (e.g., 192.168.0.1).</div>
                </div>
                <div class="col">
                    <input type="text" class="form-control" name="sport[]" placeholder="Source Port">
                    <div class="error-message">Please enter a valid port number (1-65535).</div>
                </div>
                <div class="col">
                    <input type="text" class="form-control" name="dport[]" placeholder="Destination Port">
                    <div class="error-message">Please enter a valid port number (1-65535).</div>
                </div>
            `;
            rulesContainer.appendChild(newRow);
            ruleNumber++;
        });

        document.getElementById('manualRuleButton').addEventListener('click', function() {
            var manualRuleContainer = document.getElementById('manualRuleContainer');
            if (manualRuleContainer.style.display === 'none' || manualRuleContainer.style.display === '') {
                manualRuleContainer.style.display = 'block';
            } else {
                manualRuleContainer.style.display = 'none';
            }
        });

        function removeRule(button) {
            var ruleRow = button.closest('.form-row');
            ruleRow.remove();
        }

        document.addEventListener('DOMContentLoaded', function () {
    const rulesForm = document.getElementById('rulesForm');
    const submitButton = rulesForm.querySelector('button[type="submit"]');
    const rulesContainer = document.getElementById('rulesContainer');
    const manualRuleTextarea = document.querySelector('textarea[name="manual_rule"]');

    // Function to toggle the submit button
    function toggleSubmitButton() {
        const hasNormalRules = rulesContainer.querySelectorAll('.form-row').length > 0;
        const hasManualRule = manualRuleTextarea.value.trim().length > 0;

        if (hasNormalRules || hasManualRule) {
            submitButton.disabled = false;
        } else {
            submitButton.disabled = true;
        }
    }

    // Attach event listeners to detect changes
    manualRuleTextarea.addEventListener('input', toggleSubmitButton);

    document.getElementById('addRuleButton').addEventListener('click', function () {
        // Add a new rule
        const newRow = document.createElement('div');
        newRow.className = 'form-row';
        newRow.innerHTML = `
            <div class="rule-header">
                <span>Rule</span>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeRule(this)">Delete</button>
            </div>
            <div class="col">
                <select class="form-control" name="chain[]">
                    <option value="INPUT">INPUT</option>
                    <option value="OUTPUT">OUTPUT</option>
                    <option value="FORWARD">FORWARD</option>
                </select>
            </div>
            <div class="col">
                <select class="form-control" name="target[]" required>
                    <option value="drop">DROP</option>
                    <option value="accept">ACCEPT</option>
                    <option value="reject">REJECT</option>
                    <option value="log">LOG</option>
                    <option value="return">RETURN</option>
                </select>
            </div>
            <div class="col">
                <input type="text" class="form-control" name="prot[]" placeholder="Protocol" required>
            </div>
            <div class="col">
                <input type="text" class="form-control" name="source[]" placeholder="Source" required>
            </div>
            <div class="col">
                <input type="text" class="form-control" name="destination[]" placeholder="Destination" required>
            </div>
            <div class="col">
                <input type="text" class="form-control" name="sport[]" placeholder="Source Port">
            </div>
            <div class="col">
                <input type="text" class="form-control" name="dport[]" placeholder="Destination Port">
            </div>
        `;
        rulesContainer.appendChild(newRow);

        // Update button state
        toggleSubmitButton();
    });

    window.removeRule = function (button) {
        const ruleRow = button.closest('.form-row');
        ruleRow.remove();
        toggleSubmitButton();
    };

    // Initialize the button state on load
    toggleSubmitButton();

    // Form validation on submit
    rulesForm.addEventListener('submit', function (event) {
        let isValid = true;

        // Validation for manual rule
        const manualRule = manualRuleTextarea.value.trim();
        const normalRules = rulesContainer.querySelectorAll('.form-row');

        if (!manualRule && normalRules.length === 0) {
            isValid = false;
            alert('Please fill out either the Normal Rule form or the Manual Rule form.');
        }

        if (!isValid) {
            event.preventDefault();
        }
    });
});
    </script>

{% endblock content %}

{% block javascripts %}

    <!-- ============================================================== -->
    <!-- This page plugins -->
    <!-- ============================================================== -->
    <!-- chartist chart -->
    <script src="{{ config.ASSETS_ROOT }}/plugins/chartist-js/dist/chartist.min.js"></script>
    <script src="{{ config.ASSETS_ROOT }}/plugins/chartist-plugin-tooltip-master/dist/chartist-plugin-tooltip.min.js"></script>
    <!--c3 JavaScript -->
    <script src="{{ config.ASSETS_ROOT }}/plugins/d3/d3.min.js"></script>
    <script src="{{ config.ASSETS_ROOT }}/plugins/c3-master/c3.min.js"></script>
    <!--Custom JavaScript -->
    <script src="{{ config.ASSETS_ROOT }}/js/pages/dashboards/dashboard1.js"></script>

{% endblock javascripts %}
